name: Docker Build Staging Workflow

# When this workflow is activated
on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  extract-version:
    # This job only runs if the PR targets 'staging'
    runs-on: ubuntu-latest
    outputs:
      # Output version for the following job (extracted from package.json)
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      # Clone the GitHub repository into the GitHub Actions VM.
      # Make the files available for the workflowOutput version for the next job (extracted from package.json).
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Retrieves all history and tags (important for standard version)

      # Prepare the Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install project dependencies
      - name: Install dependencies
        run: npm ci

      # Configure the Git author to be able to push the generated commit
      - name: Configure git author (for push)
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      # Generate a new version, update package.json and changelog, commit + tag (locally)
      - name: Bump version and changelog with standard-version
        run: npx standard-version

      # Pull the latest changes from the staging branch before pushing
      - name: Pull latest changes from origin/staging
        run: git pull --rebase origin staging

      # Push the commit and tag generated by standard-version
      - name: Push release commit and tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git push --follow-tags origin ${{ github.ref_name }}

      # Read the calculated version from package.json and pass it to the next job
      - name: Read version from package.json
        id: get_version
        run: |
          VERSION=$(cat package.json | jq -r '.version')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  docker-build-staging:
    # Run if client test is a success
    needs: extract-version
    # Only build docker image when merging on staging
    runs-on: ubuntu-latest
    # for existing actions, we need the keyword "uses"
    steps:
      # Clone the GitHub repository in GitHub Actions Virtual Machine
      # Make the files available by the workflow
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Retrieve all tags

      # Enable building multi-architecture images
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Initialize Docker Buildx, a Docker Build extension
      # Allows parallel build, cache, etc. And build-push-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub with secrets stored in GitHub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
         username: ${{ secrets.DOCKERHUB_USERNAME }}
         password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build Docker image and push it in DockerHub
      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
         push: true
          # Indicate where is the app to build
         context: "{{defaultContext}}:app/frontend"
          # DockerHub user's name and app's name
         tags: ${{ secrets.DOCKERHUB_USERNAME }}/askandtrust-frontend:${{ needs.extract-version.outputs.version }}

      # Build Docker image and push it in DockerHub
      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
         push: true
          # Indicate where is the app to build
         context: "{{defaultContext}}:app/backend"
          # DockerHub user's name and app's name
         tags: ${{ secrets.DOCKERHUB_USERNAME }}/askandtrust-backend:${{ needs.extract-version.outputs.version }}