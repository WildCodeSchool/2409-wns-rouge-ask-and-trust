# üöÄ Ask&Trust Server Documentation

Cette documentation compl√®te couvre la gestion du serveur Ask&Trust, les configurations actuelles, les probl√®mes identifi√©s et leurs solutions.

## üìã Table des Mati√®res

1. [üîç Analyse de Configuration Actuelle](#-analyse-de-configuration-actuelle)
2. [üõ†Ô∏è Stack Technologique & Commandes](#Ô∏è-stack-technologique--commandes)
3. [üîß Configuration des Services](#-configuration-des-services)
4. [üê≥ Gestion des Environnements](#-gestion-des-environnements)
5. [üêõ Probl√®mes Identifi√©s & Solutions](#-probl√®mes-identifi√©s--solutions)
6. [üìñ Manuel pour Novices](#-manuel-pour-novices)
7. [üö® R√©solution des Erreurs](#-r√©solution-des-erreurs)
8. [üìä Monitoring & Logs](#-monitoring--logs)

---

## üîç Analyse de Configuration Actuelle

### üìÅ Arborescence Serveur

```
.
‚îú‚îÄ‚îÄ askandtrust-prod/           # Environnement de production
‚îÇ   ‚îî‚îÄ‚îÄ apps/
‚îÇ       ‚îú‚îÄ‚îÄ CADDY_CMD.md
‚îÇ       ‚îú‚îÄ‚îÄ compose.prod.yml
‚îÇ       ‚îú‚îÄ‚îÄ fetch-and-deploy-prod.sh
‚îÇ       ‚îú‚îÄ‚îÄ fetch-tag-dockerhub.sh
‚îÇ       ‚îú‚îÄ‚îÄ logs/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ access.log
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ error.log
‚îÇ       ‚îî‚îÄ‚îÄ nginx/
‚îÇ           ‚îî‚îÄ‚îÄ nginx.conf
‚îú‚îÄ‚îÄ askandtrust-staging/        # Environnement de staging
‚îÇ   ‚îî‚îÄ‚îÄ apps/
‚îÇ       ‚îú‚îÄ‚îÄ CADDY_CMD.md
‚îÇ       ‚îú‚îÄ‚îÄ compose.staging.yml
‚îÇ       ‚îú‚îÄ‚îÄ fetch-and-deploy.sh
‚îÇ       ‚îú‚îÄ‚îÄ fetch-tag-dockerhub.sh
‚îÇ       ‚îú‚îÄ‚îÄ logs/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ access.log
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ error.log
‚îÇ       ‚îî‚îÄ‚îÄ nginx/
‚îÇ           ‚îî‚îÄ‚îÄ nginx.conf
‚îú‚îÄ‚îÄ cheatsheet/
‚îÇ   ‚îî‚îÄ‚îÄ keysmap.md
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ custom_welcome_message.sh
    ‚îî‚îÄ‚îÄ vps-status.sh
```

### üåê Configuration DNS/Caddy Actuelle

```bash
# Domaines configur√©s dans /etc/caddy/Caddyfile
092024-rouge-4.wns.wilders.dev              ‚Üí localhost:8000  # Production
staging.092024-rouge-4.wns.wilders.dev      ‚Üí localhost:8001  # Staging
ops.092024-rouge-4.wns.wilders.dev          ‚Üí localhost:9000  # Operations
```

### üê≥ Ports Docker par Environnement

```bash
# Production (askandtrust-prod)
GATEWAY_PORT_PROD=8000

# Staging (askandtrust-staging)  
GATEWAY_PORT_STAGING=8001

# Base de donn√©es
PostgreSQL Production: 5432
PostgreSQL Staging: 5433
```

---

## üõ†Ô∏è Stack Technologique & Commandes

### Frontend (React + Vite)
```bash
# Navigation vers le frontend
cd /path/to/project/app/frontend

# Installation des d√©pendances
npm install

# D√©veloppement local
npm run dev

# Build production
npm run build

# Tests
npm run test

# Linting
npm run lint
```

### Backend (Node.js + GraphQL)
```bash
# Navigation vers le backend
cd /path/to/project/app/backend

# Installation des d√©pendances
npm install

# D√©veloppement avec hot reload
npm start

# Build TypeScript
npm run build

# Tests
npm test

# Cr√©ation d'un admin
npm run create-admin
```

### Database (PostgreSQL)
```bash
# Connexion √† la base de donn√©es production
psql -h localhost -p 5432 -U ask_and_trust -d ask_and_trust

# Connexion √† la base de donn√©es staging
psql -h localhost -p 5433 -U ask_and_trust -d ask_and_trust

# V√©rification du statut production
pg_isready -U ask_and_trust -d ask_and_trust -h localhost -p 5432

# V√©rification du statut staging
pg_isready -U ask_and_trust -d ask_and_trust -h localhost -p 5433

# Backup de la DB production
pg_dump -h localhost -p 5432 -U ask_and_trust ask_and_trust > backup_prod.sql

# Backup de la DB staging
pg_dump -h localhost -p 5433 -U ask_and_trust ask_and_trust > backup_staging.sql

# Restauration de la DB
psql -h localhost -p 5432 -U ask_and_trust ask_and_trust < backup.sql
```

### Docker & Compose
```bash
# D√©veloppement local
docker compose up -d
docker compose logs -f [service_name]
docker compose down

# Production
cd ~/askandtrust-prod/apps
./fetch-and-deploy-prod.sh

# Staging
cd ~/askandtrust-staging/apps
./fetch-and-deploy.sh

# Manuel production
docker compose -f compose.prod.yml --project-name askandtrust-prod down
docker compose -f compose.prod.yml --project-name askandtrust-prod pull
docker compose -f compose.prod.yml --project-name askandtrust-prod up -d

# Manuel staging
docker compose -f compose.staging.yml --project-name askandtrust-staging down
docker compose -f compose.staging.yml --project-name askandtrust-staging pull
docker compose -f compose.staging.yml --project-name askandtrust-staging up -d

# Monitoring conteneurs
docker ps
docker stats
docker logs [container_name]

# Voir les projets s√©par√©s
docker compose ls
```

---

## üîß Configuration des Services

### Caddy (Reverse Proxy)
```bash
# V√©rification du statut
systemctl status caddy

# Restart Caddy
sudo systemctl restart caddy

# Rechargement config
sudo caddy reload --config /etc/caddy/Caddyfile

# Logs Caddy
sudo journalctl -u caddy -f

# Test configuration
sudo caddy validate --config /etc/caddy/Caddyfile
```

### Nginx (Dans Docker)
```bash
# V√©rification config nginx production
docker exec -it askandtrust-prod-nginx-1 nginx -t

# V√©rification config nginx staging
docker exec -it askandtrust-staging-nginx-1 nginx -t

# Rechargement nginx production
docker exec -it askandtrust-prod-nginx-1 nginx -s reload

# Rechargement nginx staging
docker exec -it askandtrust-staging-nginx-1 nginx -s reload

# Logs nginx production
docker logs askandtrust-prod-nginx-1

# Logs nginx staging
docker logs askandtrust-staging-nginx-1
```

### Monitoring Syst√®me
```bash
# Utilisation des ressources
htop
free -h
df -h

# Processus r√©seau
netstat -tulpn
ss -tulpn

# Logs syst√®me
journalctl -f
tail -f /var/log/syslog
```

---

## üê≥ Gestion des Environnements

### üîÑ D√©ploiement Production
```bash
# Navigation vers l'environnement production
cd ~/askandtrust-prod/apps

# D√©ploiement automatique
./fetch-and-deploy-prod.sh

# V√©rification des conteneurs production
docker ps --filter "name=askandtrust-prod"

# Logs production
docker compose -f compose.prod.yml --project-name askandtrust-prod logs -f
```

### üîÑ D√©ploiement Staging
```bash
# Navigation vers l'environnement staging
cd ~/askandtrust-staging/apps

# D√©ploiement automatique
./fetch-and-deploy.sh

# V√©rification des conteneurs staging
docker ps --filter "name=askandtrust-staging"

# Logs staging
docker compose -f compose.staging.yml --project-name askandtrust-staging logs -f
```

### üîç V√©rification des Environnements
```bash
# Voir tous les conteneurs avec leur projet
docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.Status}}"

# Voir les projets Docker Compose
docker compose ls

# Voir les r√©seaux par environnement
docker network ls | grep askandtrust

# Voir les volumes par environnement
docker volume ls | grep askandtrust
```

### üõ†Ô∏è Maintenance des Environnements
```bash
# Nettoyage production
docker compose -f compose.prod.yml --project-name askandtrust-prod down
docker system prune -f

# Nettoyage staging
docker compose -f compose.staging.yml --project-name askandtrust-staging down
docker system prune -f

# Red√©marrage complet production
cd ~/askandtrust-prod/apps
./fetch-and-deploy-prod.sh

# Red√©marrage complet staging
cd ~/askandtrust-staging/apps
./fetch-and-deploy.sh
```

---

## üìñ Manuel pour Novices

### üöÄ D√©marrage Rapide

#### 1. Connexion au Serveur
```bash
# Connexion SSH (remplacer par vos identifiants)
ssh user@092024-rouge-4.wns.wilders.dev

# V√©rification de la bienvenue Ask&Trust
# (doit s'afficher automatiquement)
```

#### 2. Navigation vers les Environnements
```bash
# Production
cd ~/askandtrust-prod/apps
pwd  # V√©rifier que vous √™tes dans le bon dossier
ls -la  # Voir les fichiers disponibles

# Staging
cd ~/askandtrust-staging/apps
pwd  # V√©rifier que vous √™tes dans le bon dossier
ls -la  # Voir les fichiers disponibles
```

#### 3. V√©rification de l'√âtat des Services
```bash
# Services syst√®me
sudo systemctl status caddy

# Conteneurs Docker - Production
docker ps --filter "name=askandtrust-prod"

# Conteneurs Docker - Staging
docker ps --filter "name=askandtrust-staging"

# Utilisation des ressources
free -h
df -h
```

#### 4. D√©ploiement Standard
```bash
# Production
cd ~/askandtrust-prod/apps
./fetch-and-deploy-prod.sh

# Staging
cd ~/askandtrust-staging/apps
./fetch-and-deploy.sh

# V√©rification des logs
docker compose -f compose.prod.yml --project-name askandtrust-prod logs -f
docker compose -f compose.staging.yml --project-name askandtrust-staging logs -f
```

### üîç Commandes de Diagnostic

#### V√©rification R√©seau
```bash
# Tester la connectivit√© production
curl http://localhost:8000
curl http://localhost:8000/api/v1

# Tester la connectivit√© staging
curl http://localhost:8001
curl http://localhost:8001/api/v1

# Tester depuis l'ext√©rieur - Production
curl https://092024-rouge-4.wns.wilders.dev
curl https://092024-rouge-4.wns.wilders.dev/api/v1

# Tester depuis l'ext√©rieur - Staging
curl https://staging.092024-rouge-4.wns.wilders.dev
curl https://staging.092024-rouge-4.wns.wilders.dev/api/v1
```

#### V√©rification Base de Donn√©es
```bash
# Status de PostgreSQL production
docker exec -it askandtrust-prod-db-1 pg_isready -U ask_and_trust

# Status de PostgreSQL staging
docker exec -it askandtrust-staging-db-1 pg_isready -U ask_and_trust

# Connexion √† la DB production
docker exec -it askandtrust-prod-db-1 psql -U ask_and_trust -d ask_and_trust

# Connexion √† la DB staging
docker exec -it askandtrust-staging-db-1 psql -U ask_and_trust -d ask_and_trust
```

#### V√©rification des Logs
```bash
# Logs production
docker compose -f compose.prod.yml --project-name askandtrust-prod logs

# Logs staging
docker compose -f compose.staging.yml --project-name askandtrust-staging logs

# Logs d'un service sp√©cifique - Production
docker compose -f compose.prod.yml --project-name askandtrust-prod logs frontend
docker compose -f compose.prod.yml --project-name askandtrust-prod logs backend
docker compose -f compose.prod.yml --project-name askandtrust-prod logs nginx

# Logs d'un service sp√©cifique - Staging
docker compose -f compose.staging.yml --project-name askandtrust-staging logs frontend
docker compose -f compose.staging.yml --project-name askandtrust-staging logs backend
docker compose -f compose.staging.yml --project-name askandtrust-staging logs nginx

# Logs syst√®me
sudo journalctl -u caddy
tail -f ~/askandtrust-prod/apps/logs/access.log
tail -f ~/askandtrust-staging/apps/logs/access.log
```

### üìù Checklist de V√©rification

- [ ] **Services actifs**
  - [ ] Caddy: `systemctl status caddy`
  - [ ] Docker: `docker ps`
  - [ ] Base de donn√©es production: Conteneur PostgreSQL running sur port 5432
  - [ ] Base de donn√©es staging: Conteneur PostgreSQL running sur port 5433

- [ ] **Connectivit√© r√©seau**
  - [ ] Port 8000 ouvert (production): `netstat -tulpn | grep 8000`
  - [ ] Port 8001 ouvert (staging): `netstat -tulpn | grep 8001`
  - [ ] DNS production configur√©: `nslookup 092024-rouge-4.wns.wilders.dev`
  - [ ] DNS staging configur√©: `nslookup staging.092024-rouge-4.wns.wilders.dev`

- [ ] **Fichiers de configuration**
  - [ ] `/etc/caddy/Caddyfile` correct
  - [ ] `~/askandtrust-prod/apps/nginx/nginx.conf` correct
  - [ ] `~/askandtrust-staging/apps/nginx/nginx.conf` correct
  - [ ] `.env` avec bonnes variables dans chaque environnement

- [ ] **Ressources syst√®me**
  - [ ] RAM disponible: `free -h`
  - [ ] Espace disque: `df -h`
  - [ ] Load syst√®me: `uptime`

---

## üö® R√©solution des Erreurs

### 502 Bad Gateway
```bash
# 1. V√©rifier que le backend production est accessible
docker exec -it askandtrust-prod-backend-1 curl http://localhost:3310/graphql

# 2. V√©rifier que le backend staging est accessible
docker exec -it askandtrust-staging-backend-1 curl http://localhost:3310/graphql

# 3. V√©rifier la configuration nginx production
docker exec -it askandtrust-prod-nginx-1 cat /etc/nginx/nginx.conf

# 4. V√©rifier la configuration nginx staging
docker exec -it askandtrust-staging-nginx-1 cat /etc/nginx/nginx.conf

# 5. Red√©marrer nginx production
docker restart askandtrust-prod-nginx-1

# 6. Red√©marrer nginx staging
docker restart askandtrust-staging-nginx-1
```

### Service Unavailable
```bash
# 1. V√©rifier Caddy
sudo systemctl status caddy
sudo systemctl restart caddy

# 2. V√©rifier les ports
netstat -tulpn | grep -E "(8000|8001|9000)"

# 3. V√©rifier les logs
sudo journalctl -u caddy -n 50
```

### Probl√®mes de Base de Donn√©es
```bash
# 1. V√©rifier la connectivit√© production
docker exec -it askandtrust-prod-db-1 pg_isready

# 2. V√©rifier la connectivit√© staging
docker exec -it askandtrust-staging-db-1 pg_isready

# 3. V√©rifier les variables d'environnement production
docker exec -it askandtrust-prod-backend-1 env | grep DB

# 4. V√©rifier les variables d'environnement staging
docker exec -it askandtrust-staging-backend-1 env | grep DB

# 5. Red√©marrer la base production
docker restart askandtrust-prod-db-1

# 6. Red√©marrer la base staging
docker restart askandtrust-staging-db-1
```

---

## üìä Monitoring & Logs

### üìà Surveillance Continue
```bash
# Script de monitoring (utiliser vps-status.sh)
cd ~/scripts
./vps-status.sh

# Monitoring en temps r√©el - Production
watch -n 5 'docker ps --filter "name=askandtrust-prod" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# Monitoring en temps r√©el - Staging
watch -n 5 'docker ps --filter "name=askandtrust-staging" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# Monitoring des ressources
watch -n 2 'free -h && echo && df -h'
```

### üìã Logs Centralis√©s

#### Structure des Logs
```
askandtrust-prod/apps/logs/
‚îú‚îÄ‚îÄ access.log          # Logs d'acc√®s Nginx production
‚îî‚îÄ‚îÄ error.log           # Logs d'erreur Nginx production

askandtrust-staging/apps/logs/
‚îú‚îÄ‚îÄ access.log          # Logs d'acc√®s Nginx staging
‚îî‚îÄ‚îÄ error.log           # Logs d'erreur Nginx staging

scripts/
‚îî‚îÄ‚îÄ vps_status_*.log    # Rapports syst√®me p√©riodiques
```

#### Commandes de Log
```bash
# Logs en temps r√©el - Production
tail -f ~/askandtrust-prod/apps/logs/access.log
tail -f ~/askandtrust-prod/apps/logs/error.log

# Logs en temps r√©el - Staging
tail -f ~/askandtrust-staging/apps/logs/access.log
tail -f ~/askandtrust-staging/apps/logs/error.log

# Recherche dans les logs production
grep "error" ~/askandtrust-prod/apps/logs/error.log
grep "502" ~/askandtrust-prod/apps/logs/access.log

# Recherche dans les logs staging
grep "error" ~/askandtrust-staging/apps/logs/error.log
grep "502" ~/askandtrust-staging/apps/logs/access.log

# Logs Docker - Production
docker compose -f compose.prod.yml --project-name askandtrust-prod logs --tail=100

# Logs Docker - Staging
docker compose -f compose.staging.yml --project-name askandtrust-staging logs --tail=100
```

### üîî Alertes et Notifications

#### Configuration d'Alertes Basiques
```bash
# Script de v√©rification automatique production (√† ajouter dans crontab)
#!/bin/bash
if ! curl -f -s http://localhost:8000 > /dev/null; then
    echo "Production service down at $(date)" >> /var/log/service-alerts.log
    # Ajouter notification email/slack ici
fi

# Script de v√©rification automatique staging (√† ajouter dans crontab)
#!/bin/bash
if ! curl -f -s http://localhost:8001 > /dev/null; then
    echo "Staging service down at $(date)" >> /var/log/service-alerts.log
    # Ajouter notification email/slack ici
fi
```

#### Crontab pour Monitoring
```bash
# Editer crontab
crontab -e

# Ajouter v√©rifications automatiques
*/5 * * * * /path/to/health-check-prod.sh
*/5 * * * * /path/to/health-check-staging.sh
0 2 * * * /path/to/scripts/vps-status.sh
```

---

## üîß Commandes de Maintenance

### Maintenance Pr√©ventive
```bash
# Nettoyage Docker
docker system prune -a

# Mise √† jour des images production
docker compose -f compose.prod.yml --project-name askandtrust-prod pull

# Mise √† jour des images staging
docker compose -f compose.staging.yml --project-name askandtrust-staging pull

# Backup de la base de donn√©es production
docker exec askandtrust-prod-db-1 pg_dump -U ask_and_trust ask_and_trust > backup_prod_$(date +%Y%m%d).sql

# Backup de la base de donn√©es staging
docker exec askandtrust-staging-db-1 pg_dump -U ask_and_trust ask_and_trust > backup_staging_$(date +%Y%m%d).sql

# Rotation des logs
logrotate /etc/logrotate.d/askandtrust
```

### Mise √† Jour de Version
```bash
# 1. R√©cup√©rer la derni√®re version - Production
cd ~/askandtrust-prod/apps
./fetch-tag-dockerhub.sh

# 2. R√©cup√©rer la derni√®re version - Staging
cd ~/askandtrust-staging/apps
./fetch-tag-dockerhub.sh

# 3. V√©rifier la version
cat .env | grep VERSION

# 4. D√©ployer production
cd ~/askandtrust-prod/apps
./fetch-and-deploy-prod.sh

# 5. D√©ployer staging
cd ~/askandtrust-staging/apps
./fetch-and-deploy.sh

# 6. V√©rifier le d√©ploiement
curl https://092024-rouge-4.wns.wilders.dev
curl https://staging.092024-rouge-4.wns.wilders.dev
```

---

## üìû Support et R√©f√©rences

### üÜò En Cas de Probl√®me

1. **V√©rifier les logs** (voir section Monitoring)
2. **Red√©marrer les services** dans l'ordre:
   ```bash
   # Production
   docker compose -f compose.prod.yml --project-name askandtrust-prod restart
   
   # Staging
   docker compose -f compose.staging.yml --project-name askandtrust-staging restart
   
   # Caddy
   sudo systemctl restart caddy
   ```
3. **V√©rifier la configuration** (voir Checklist)
4. **Contacter l'√©quipe de d√©veloppement**

### üìö R√©f√©rences Utiles

- **Documentation Docker Compose**: https://docs.docker.com/compose/
- **Documentation Caddy**: https://caddyserver.com/docs/
- **Documentation Nginx**: https://nginx.org/en/docs/
- **Documentation PostgreSQL**: https://www.postgresql.org/docs/

---

*Documentation maintenue par YohanGH - Derni√®re mise √† jour: 17-01-2025*