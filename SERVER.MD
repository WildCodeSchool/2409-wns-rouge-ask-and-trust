# üöÄ Ask&Trust Server Documentation

Cette documentation compl√®te couvre la gestion du serveur Ask&Trust, les configurations actuelles, les probl√®mes identifi√©s et leurs solutions.

## üìã Table des Mati√®res

1. [üîç Analyse de Configuration Actuelle](#-analyse-de-configuration-actuelle)
2. [üõ†Ô∏è Stack Technologique & Commandes](#Ô∏è-stack-technologique--commandes)
3. [üîß Configuration des Services](#-configuration-des-services)
4. [üêõ Probl√®mes Identifi√©s & Solutions](#-probl√®mes-identifi√©s--solutions)
5. [üìñ Manuel pour Novices](#-manuel-pour-novices)
6. [üö® R√©solution des Erreurs](#-r√©solution-des-erreurs)
7. [üìä Monitoring & Logs](#-monitoring--logs)

---

## üîç Analyse de Configuration Actuelle

### üìÅ Arborescence Serveur

```
.
‚îú‚îÄ‚îÄ askandtrust/
‚îÇ   ‚îî‚îÄ‚îÄ apps/
‚îÇ       ‚îú‚îÄ‚îÄ CADDY_CMD.md
‚îÇ       ‚îú‚îÄ‚îÄ compose.prod.yml
‚îÇ       ‚îú‚îÄ‚îÄ database.env
‚îÇ       ‚îú‚îÄ‚îÄ fetch-and-deploy.sh
‚îÇ       ‚îú‚îÄ‚îÄ fetch-tag-dockerhub.sh
‚îÇ       ‚îú‚îÄ‚îÄ logs/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ access.log
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ error.log
‚îÇ       ‚îî‚îÄ‚îÄ nginx/
‚îÇ           ‚îî‚îÄ‚îÄ nginx.conf
‚îú‚îÄ‚îÄ cheatsheet/
‚îÇ   ‚îî‚îÄ‚îÄ keysmap.md
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ custom_welcome_message.sh
    ‚îî‚îÄ‚îÄ vps-status.sh
```

### üåê Configuration DNS/Caddy Actuelle

```bash
# Domaines configur√©s dans /etc/caddy/Caddyfile
092024-rouge-4.wns.wilders.dev              ‚Üí localhost:8000
staging.092024-rouge-4.wns.wilders.dev      ‚Üí localhost:8001  ‚úÖ Fonctionne
ops.092024-rouge-4.wns.wilders.dev          ‚Üí localhost:9000
```

### üê≥ Ports Docker

```bash
# Port d√©fini dans fetch-and-deploy.sh
GATEWAY_PORT=8001  # Used by staging environment
```

---

## üõ†Ô∏è Stack Technologique & Commandes

### Frontend (React + Vite)
```bash
# Navigation vers le frontend
cd /path/to/project/app/frontend

# Installation des d√©pendances
npm install

# D√©veloppement local
npm run dev

# Build production
npm run build

# Tests
npm run test

# Linting
npm run lint
```

### Backend (Node.js + GraphQL)
```bash
# Navigation vers le backend
cd /path/to/project/app/backend

# Installation des d√©pendances
npm install

# D√©veloppement avec hot reload
npm start

# Build TypeScript
npm run build

# Tests
npm test

# Cr√©ation d'un admin
npm run create-admin
```

### Database (PostgreSQL)
```bash
# Connexion √† la base de donn√©es
psql -h localhost -p 5432 -U ask_and_trust -d ask_and_trust

# V√©rification du statut
pg_isready -U ask_and_trust -d ask_and_trust -h localhost

# Backup de la DB
pg_dump -h localhost -p 5432 -U ask_and_trust ask_and_trust > backup.sql

# Restauration de la DB
psql -h localhost -p 5432 -U ask_and_trust ask_and_trust < backup.sql
```

### Docker & Compose
```bash
# D√©veloppement local
docker compose up -d
docker compose logs -f [service_name]
docker compose down

# Production (staging)
cd /path/to/askandtrust/apps
./fetch-and-deploy.sh

# Manuel production
docker compose -f compose.prod.yml down
docker compose -f compose.prod.yml pull
docker compose -f compose.prod.yml up -d

# Monitoring conteneurs
docker ps
docker stats
docker logs [container_name]
```

---

## üîß Configuration des Services

### Caddy (Reverse Proxy)
```bash
# V√©rification du statut
systemctl status caddy

# Restart Caddy
sudo systemctl restart caddy

# Rechargement config
sudo caddy reload --config /etc/caddy/Caddyfile

# Logs Caddy
sudo journalctl -u caddy -f

# Test configuration
sudo caddy validate --config /etc/caddy/Caddyfile
```

### Nginx (Dans Docker)
```bash
# V√©rification config nginx dans le conteneur
docker exec -it [nginx_container] nginx -t

# Rechargement nginx
docker exec -it [nginx_container] nginx -s reload

# Logs nginx
docker logs [nginx_container]
```

### Monitoring Syst√®me
```bash
# Utilisation des ressources
htop
free -h
df -h

# Processus r√©seau
netstat -tulpn
ss -tulpn

# Logs syst√®me
journalctl -f
tail -f /var/log/syslog
```

---

## üìñ Manuel pour Novices

### üöÄ D√©marrage Rapide

#### 1. Connexion au Serveur
```bash
# Connexion SSH (remplacer par vos identifiants)
ssh user@092024-rouge-4.wns.wilders.dev

# V√©rification de la bienvenue Ask&Trust
# (doit s'afficher automatiquement)
```

#### 2. Navigation vers le Projet
```bash
cd ~/askandtrust/apps
pwd  # V√©rifier que vous √™tes dans le bon dossier
ls -la  # Voir les fichiers disponibles
```

#### 3. V√©rification de l'√âtat des Services
```bash
# Services syst√®me
sudo systemctl status caddy

# Conteneurs Docker
docker ps

# Utilisation des ressources
free -h
df -h
```

#### 4. D√©ploiement Standard
```bash
# Mise √† jour et d√©ploiement automatique
./fetch-and-deploy.sh

# V√©rification des logs
docker compose -f compose.prod.yml logs -f
```

### üîç Commandes de Diagnostic

#### V√©rification R√©seau
```bash
# Tester la connectivit√© locale
curl http://localhost:8001
curl http://localhost:8001/api/v1

# Tester depuis l'ext√©rieur
curl https://staging.092024-rouge-4.wns.wilders.dev
curl https://staging.092024-rouge-4.wns.wilders.dev/api/v1
```

#### V√©rification Base de Donn√©es
```bash
# Status de PostgreSQL dans Docker
docker exec -it [db_container] pg_isready -U ask_and_trust

# Connexion √† la DB
docker exec -it [db_container] psql -U ask_and_trust -d ask_and_trust
```

#### V√©rification des Logs
```bash
# Logs de tous les services
docker compose -f compose.prod.yml logs

# Logs d'un service sp√©cifique
docker compose -f compose.prod.yml logs frontend
docker compose -f compose.prod.yml logs backend
docker compose -f compose.prod.yml logs nginx

# Logs syst√®me
sudo journalctl -u caddy
tail -f logs/access.log
tail -f logs/error.log
```

### üìù Checklist de V√©rification

- [ ] **Services actifs**
  - [ ] Caddy: `systemctl status caddy`
  - [ ] Docker: `docker ps`
  - [ ] Base de donn√©es: Conteneur PostgreSQL running

- [ ] **Connectivit√© r√©seau**
  - [ ] Port 8001 ouvert: `netstat -tulpn | grep 8001`
  - [ ] DNS configur√©: `nslookup staging.092024-rouge-4.wns.wilders.dev`

- [ ] **Fichiers de configuration**
  - [ ] `/etc/caddy/Caddyfile` correct
  - [ ] `nginx/nginx.conf` correct
  - [ ] `.env` avec bonnes variables

- [ ] **Ressources syst√®me**
  - [ ] RAM disponible: `free -h`
  - [ ] Espace disque: `df -h`
  - [ ] Load syst√®me: `uptime`

---

## üö® R√©solution des Erreurs

### 502 Bad Gateway
```bash
# 1. V√©rifier que le backend est accessible
docker exec -it [backend_container] curl http://localhost:3310/graphql

# 2. V√©rifier la configuration nginx
docker exec -it [nginx_container] cat /etc/nginx/nginx.conf

# 3. Red√©marrer nginx
docker restart [nginx_container]
```

### Service Unavailable
```bash
# 1. V√©rifier Caddy
sudo systemctl status caddy
sudo systemctl restart caddy

# 2. V√©rifier les ports
netstat -tulpn | grep -E "(8000|8001|9000)"

# 3. V√©rifier les logs
sudo journalctl -u caddy -n 50
```

### Probl√®mes de Base de Donn√©es
```bash
# 1. V√©rifier la connectivit√©
docker exec -it [db_container] pg_isready

# 2. V√©rifier les variables d'environnement
docker exec -it [backend_container] env | grep DB

# 3. Red√©marrer la base
docker restart [db_container]
```

---

## üìä Monitoring & Logs

### üìà Surveillance Continue
```bash
# Script de monitoring (utiliser vps-status.sh)
cd ~/scripts
./vps-status.sh

# Monitoring en temps r√©el
watch -n 5 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# Monitoring des ressources
watch -n 2 'free -h && echo && df -h'
```

### üìã Logs Centralis√©s

#### Structure des Logs
```
logs/
‚îú‚îÄ‚îÄ access.log          # Logs d'acc√®s Nginx
‚îú‚îÄ‚îÄ error.log           # Logs d'erreur Nginx
‚îî‚îÄ‚îÄ vps_status_*.log    # Rapports syst√®me p√©riodiques
```

#### Commandes de Log
```bash
# Logs en temps r√©el
tail -f logs/access.log
tail -f logs/error.log

# Recherche dans les logs
grep "error" logs/error.log
grep "502" logs/access.log

# Logs Docker
docker compose -f compose.prod.yml logs --tail=100
```

### üîî Alertes et Notifications

#### Configuration d'Alertes Basiques
```bash
# Script de v√©rification automatique (√† ajouter dans crontab)
#!/bin/bash
if ! curl -f -s http://localhost:8001 > /dev/null; then
    echo "Service down at $(date)" >> /var/log/service-alerts.log
    # Ajouter notification email/slack ici
fi
```

#### Crontab pour Monitoring
```bash
# Editer crontab
crontab -e

# Ajouter v√©rifications automatiques
*/5 * * * * /path/to/health-check.sh
0 2 * * * /path/to/scripts/vps-status.sh
```

---

## üîß Commandes de Maintenance

### Maintenance Pr√©ventive
```bash
# Nettoyage Docker
docker system prune -a

# Mise √† jour des images
docker compose -f compose.prod.yml pull

# Backup de la base de donn√©es
docker exec [db_container] pg_dump -U ask_and_trust ask_and_trust > backup_$(date +%Y%m%d).sql

# Rotation des logs
logrotate /etc/logrotate.d/askandtrust
```

### Mise √† Jour de Version
```bash
# 1. R√©cup√©rer la derni√®re version
./fetch-tag-dockerhub.sh

# 2. V√©rifier la version
cat .env | grep VERSION

# 3. D√©ployer
./fetch-and-deploy.sh

# 4. V√©rifier le d√©ploiement
curl https://staging.092024-rouge-4.wns.wilders.dev
```

---

## üìû Support et R√©f√©rences

### üÜò En Cas de Probl√®me

1. **V√©rifier les logs** (voir section Monitoring)
2. **Red√©marrer les services** dans l'ordre:
   ```bash
   docker compose -f compose.prod.yml restart
   sudo systemctl restart caddy
   ```
3. **V√©rifier la configuration** (voir Checklist)
4. **Contacter l'√©quipe de d√©veloppement**

### üìö R√©f√©rences Utiles

- **Documentation Docker Compose**: https://docs.docker.com/compose/
- **Documentation Caddy**: https://caddyserver.com/docs/
- **Documentation Nginx**: https://nginx.org/en/docs/
- **Documentation PostgreSQL**: https://www.postgresql.org/docs/

---

*Documentation maintenue par YohanGH - Derni√®re mise √† jour: $(date)*

## üîß Corrections Appliqu√©es

### ‚úÖ Corrections Automatiques Effectu√©es

#### 1. **Fix compose.prod.yaml - Variable GATEWAY_PORT**
```diff
- - ${{GATEAWAY_PORT}}:80
+ - ${GATEWAY_PORT}:80
```

#### 2. **Fix nginx.conf - Routage API GraphQL**
```diff
location /api/v1 {
-   proxy_pass http://backend:3310;
+   proxy_pass http://backend:3310/graphql;
+   proxy_set_header Host $host;
+   proxy_set_header X-Real-IP $remote_addr;
+   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
+   proxy_set_header X-Forwarded-Proto $scheme;
}
```

### üîß Correction Manuelle Requise - Configuration Caddy

**Probl√®me**: Le domaine principal ne fonctionne pas car il pointe vers un port inexistant.

**Configuration actuelle** (`/etc/caddy/Caddyfile`):
```caddyfile
092024-rouge-4.wns.wilders.dev {
    reverse_proxy localhost:8000  # ‚ùå Port 8000 n'existe pas
}
```

**Solutions propos√©es**:

**Option A** - Pointer vers staging (recommand√© pour tests):
```caddyfile
092024-rouge-4.wns.wilders.dev {
    reverse_proxy localhost:8001
}
```

**Option B** - Cr√©er un environnement de production s√©par√©:
```caddyfile
092024-rouge-4.wns.wilders.dev {
    reverse_proxy localhost:8000
}
```
*Note: N√©cessite de cr√©er un nouveau d√©ploiement sur le port 8000*

**Commandes pour appliquer la correction**:
```bash
# √âditer le Caddyfile
sudo nano /etc/caddy/Caddyfile

# Valider la configuration
sudo caddy validate --config /etc/caddy/Caddyfile

# Recharger Caddy
sudo caddy reload --config /etc/caddy/Caddyfile

# V√©rifier le statut
systemctl status caddy
```

## üéØ R√©capitulatif et Prochaines √âtapes

### ‚úÖ Corrections Automatiques Appliqu√©es
1. **compose.prod.yaml**: Typo GATEAWAY_PORT ‚Üí GATEWAY_PORT corrig√©e
2. **nginx.conf**: Routage API corrig√© vers `/graphql` avec headers appropri√©s

### üîß Actions Manuelles Requises

#### 1. **Correction Caddy (CRITIQUE)**
```bash
# Se connecter au serveur
ssh user@092024-rouge-4.wns.wilders.dev

# √âditer Caddyfile 
sudo nano /etc/caddy/Caddyfile

# Changer:
# 092024-rouge-4.wns.wilders.dev {
#     reverse_proxy localhost:8000
# }

# Vers:
# 092024-rouge-4.wns.wilders.dev {
#     reverse_proxy localhost:8001
# }

# Recharger Caddy
sudo caddy reload --config /etc/caddy/Caddyfile
```

#### 2. **Red√©ploiement avec Corrections**
```bash
# Aller dans le dossier de d√©ploiement
cd ~/askandtrust/apps

# Red√©ployer avec les nouvelles configurations
./fetch-and-deploy.sh

# V√©rifier les logs
docker compose -f compose.prod.yml logs -f
```

### üß™ Tests de Validation

#### Tests √† effectuer apr√®s corrections:
```bash
# 1. Test domaine principal
curl https://092024-rouge-4.wns.wilders.dev
# Attendu: Page d'accueil Ask&Trust

# 2. Test staging (doit toujours fonctionner)
curl https://staging.092024-rouge-4.wns.wilders.dev
# Attendu: Page d'accueil Ask&Trust

# 3. Test API GraphQL
curl -X POST https://staging.092024-rouge-4.wns.wilders.dev/api/v1 \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __schema { queryType { name } } }"}'
# Attendu: R√©ponse GraphQL (plus d'erreur 502)

# 4. Test depuis le serveur
curl http://localhost:8001
curl http://localhost:8001/api/v1
```

### üìä Statut des Probl√®mes

### üöÄ Apr√®s Validation

#### Si tout fonctionne:
```bash
# Commit des changements dans le repo
git add nginx/nginx.conf compose.prod.yaml SERVER.MD
git commit -m "fix: correct nginx API routing and compose.prod typo

- Fix nginx proxy_pass to point to /graphql endpoint
- Add proper proxy headers for nginx
- Correct GATEAWAY_PORT typo in compose.prod.yaml
- Add comprehensive server documentation"

git push origin develop
```

#### Surveillance Continue:
```bash
# Monitoring
watch -n 30 'curl -s -o /dev/null -w "%{http_code}" https://staging.092024-rouge-4.wns.wilders.dev'

# Logs
tail -f ~/askandtrust/apps/logs/access.log
docker compose -f ~/askandtrust/apps/compose.prod.yml logs -f
```

