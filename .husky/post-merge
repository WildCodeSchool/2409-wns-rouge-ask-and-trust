#!/usr/bin/env sh

echo "ðŸ”„ Running post-merge automation..."

# Check if package.json or lockfile changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -E "(package.*\.json|pnpm-lock\.yaml)$"; then
  echo "ðŸ“¦ Dependencies changed, updating..."
  
  # Install new dependencies
  pnpm install --frozen-lockfile
  
  if [ $? -eq 0 ]; then
    echo "âœ… Dependencies updated successfully"
  else
    echo "âš ï¸ Dependency update failed - manual intervention required"
    echo "Run 'pnpm install' manually to resolve"
  fi
fi

# Check if database schema files changed (customize paths as needed)
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -E "(database|migrations|entities)" | grep -E "\.(ts|sql)$"; then
  echo "ðŸ—„ï¸ Database schema changes detected"
  echo "âš ï¸ Consider running database migrations if needed"
fi

# Check if configuration files changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -E "(\.env\.example|docker|compose)" | grep -E "\.(yaml|yml|env)$"; then
  echo "âš™ï¸ Configuration files changed"
  echo "ðŸ’¡ Review and update your local .env files if needed"
fi

# Clear any stale caches
echo "ðŸ§¹ Clearing development caches..."
rm -rf app/frontend/.eslintcache 2>/dev/null || true
rm -rf app/frontend/node_modules/.cache 2>/dev/null || true

echo "âœ… Post-merge automation completed!" 