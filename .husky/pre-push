#!/usr/bin/env sh

echo "ğŸš€ Running comprehensive pre-push checks..."

# Exit on any command failure
set -e

# 1. Security audit (critical vulnerabilities only for pre-push)
echo "ğŸ”’ Running comprehensive security audit..."
pnpm audit --audit-level=moderate
if [ $? -ne 0 ]; then
  echo "âŒ Security vulnerabilities detected!"
  echo "Fix vulnerabilities before pushing"
  exit 1
fi

# 2. License compliance check
echo "ğŸ“„ Checking license compliance..."
if command -v npx >/dev/null 2>&1; then
  npx license-checker --summary --onlyAllow 'MIT;BSD;Apache-2.0;ISC;GPL-2.0;GPL-3.0' || {
    echo "âš ï¸ License compliance check failed or found restricted licenses"
    echo "Review dependencies' licenses before pushing"
  }
fi

# 3. Type checking (all projects)
echo "ğŸ” Type checking all projects..."
pnpm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type checking failed!"
  exit 1
fi

# 4. Full linting with auto-fix disabled
echo "ğŸ¨ Running comprehensive linting..."
pnpm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed!"
  echo "Run 'pnpm run lint:fix' to auto-fix issues"
  exit 1
fi

# 5. Comprehensive test suite with coverage
echo "ğŸ§ª Running full test suite with coverage..."
pnpm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed!"
  exit 1
fi

# 6. Build verification (ensure everything compiles)
echo "ğŸ—ï¸ Building all projects..."
pnpm run build:frontend
if [ $? -ne 0 ]; then
  echo "âŒ Frontend build failed!"
  exit 1
fi

# Backend build check (if build script exists)
if grep -q '"build"' app/backend/package.json; then
  pnpm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Backend build failed!"
    exit 1
  fi
else
  echo "â„¹ï¸  Backend build script not configured"
fi

# 7. Bundle size analysis (if applicable)
echo "ğŸ“Š Analyzing bundle size..."
cd app/frontend
if [ -f "dist/assets" ] || [ -d "dist/assets" ]; then
  echo "Frontend bundle analysis:"
  find dist -name "*.js" -exec wc -c {} + | sort -n || echo "No JS bundles found"
  find dist -name "*.css" -exec wc -c {} + | sort -n || echo "No CSS bundles found"
fi
cd ../..

# 8. Documentation build check
echo "ğŸ“š Verifying documentation build..."
if command -v typedoc >/dev/null 2>&1; then
  pnpm run docs --dry-run || echo "âš ï¸ Documentation build may have issues"
fi

# 9. Final dependency check
echo "ğŸ” Final dependency verification..."
pnpm install --frozen-lockfile --silent
if [ $? -ne 0 ]; then
  echo "âŒ Dependency lock file is out of sync!"
  echo "Run 'pnpm install' and commit the updated lockfile"
  exit 1
fi

echo ""
echo "âœ… All pre-push checks passed! ğŸš€"
echo "ğŸ“Š Summary:"
echo "  â€¢ Security audit: âœ…"
echo "  â€¢ Type checking: âœ…"
echo "  â€¢ Linting: âœ…"
echo "  â€¢ Tests with coverage: âœ…"
echo "  â€¢ Build verification: âœ…"
echo "  â€¢ Dependencies: âœ…"
echo ""
echo "Ready to push! ğŸ‰"
