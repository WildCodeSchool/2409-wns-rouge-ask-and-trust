#!/usr/bin/env sh

# Trigger : Before pushing to remote
# Duration : ~10-30 seconds (optimized based on changed files)
# Actions :
#   - Detect which parts of codebase were modified (frontend/backend)
#   - Run TypeScript, linting, and tests only for modified sections
#   - Block push if any check fails
# Goal : Quick quality filter to catch obvious errors early

echo "ğŸš€ Running pre-push checks (Husky config mode)..."

# TEMPORARY: Skip TypeScript checks during Husky configuration
echo "âš ï¸  TEMPORARY: Skipping TypeScript checks (Husky config mode)"

# Detect which parts of the codebase were modified
echo "ğŸ” Detecting modified files..."
MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

# Check if frontend files were modified
FRONTEND_MODIFIED=false
if echo "$MODIFIED_FILES" | grep -q "^app/frontend/"; then
  FRONTEND_MODIFIED=true
  echo "ğŸ“± Frontend changes detected"
fi

# Check if backend files were modified
BACKEND_MODIFIED=false
if echo "$MODIFIED_FILES" | grep -q "^app/backend/"; then
  BACKEND_MODIFIED=true
  echo "ğŸ–¥ï¸  Backend changes detected"
fi

# If no specific frontend/backend changes, run all checks (for root files, configs, etc.)
if [ "$FRONTEND_MODIFIED" = false ] && [ "$BACKEND_MODIFIED" = false ]; then
  echo "ğŸ”§ Root/config changes detected - running all checks"
  FRONTEND_MODIFIED=true
  BACKEND_MODIFIED=true
fi

# Frontend checks (only if frontend was modified)
if [ "$FRONTEND_MODIFIED" = true ]; then
  echo "ğŸ¨ Linting frontend..."
  cd app/frontend && npm run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend linting failed!"
    exit 1
  fi
  cd ../..

  echo "ğŸ§ª Running frontend tests..."
  cd app/frontend && npm run test -- --run
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Frontend tests failed - continuing anyway (Husky config mode)"
    exit 1
  fi
  cd ../..

  # Frontend build check (commented out for now)
  # echo "ğŸ—ï¸ Frontend build check..."
  # cd app/frontend && npm run build
  # if [ $? -ne 0 ]; then
  #   echo "âš ï¸  Frontend build failed - continuing anyway (Husky config mode)"
  # fi
  # cd ../..
else
  echo "â­ï¸  Skipping frontend checks (no changes detected)"
fi

# Backend checks (only if backend was modified)
if [ "$BACKEND_MODIFIED" = true ]; then
  echo "ğŸ¨ Linting backend..."
  cd app/backend && npm run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Backend linting failed!"
    exit 1
  fi
  cd ../..

  echo "ğŸ§ª Running backend tests..."
  cd app/backend && npm run test
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Backend tests failed - continuing anyway (Husky config mode)"
    exit 1
  fi
  cd ../..

  # Backend build check (commented out for now)
  # echo "ğŸ—ï¸ Backend build check..."
  # cd app/backend && npm run build
  # if [ $? -ne 0 ]; then
  #   echo "âš ï¸  Backend build failed - continuing anyway (Husky config mode)"
  # fi
  # cd ../..
else
  echo "â­ï¸  Skipping backend checks (no changes detected)"
fi

echo "âœ… Pre-push checks completed (Husky config mode)!"
echo "ğŸ’¡ Remember to restore full checks after merging Husky config"
