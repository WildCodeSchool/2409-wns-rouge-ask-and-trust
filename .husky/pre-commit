#!/usr/bin/env sh

# Trigger : At each git commit
# Duration : ~10-30 seconds
# Actions :
#   - TypeScript frontend check (tsc --noEmit)
#   - Prettier formatting of staged files via lint-staged
#   - Block commit if any check fails
# Goal : Quick quality filter to catch obvious errors early

echo "üöÄ Running pre-commit checks..."

# Detect which parts of the codebase were modified
echo "üîç Detecting modified files..."
MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

# Check if frontend files were modified
FRONTEND_MODIFIED=false
if echo "$MODIFIED_FILES" | grep -q "^app/frontend/"; then
  FRONTEND_MODIFIED=true
  echo "üì± Frontend changes detected"
fi

# Check if backend files were modified
BACKEND_MODIFIED=false
if echo "$MODIFIED_FILES" | grep -q "^app/backend/"; then
  BACKEND_MODIFIED=true
  echo "üñ•Ô∏è  Backend changes detected"
fi

# If no specific frontend/backend changes, run all checks (for root files, configs, etc.)
if [ "$FRONTEND_MODIFIED" = false ] && [ "$BACKEND_MODIFIED" = false ]; then
  echo "üîß Root/config changes detected - running all checks"
  FRONTEND_MODIFIED=true
  BACKEND_MODIFIED=true
fi

# Frontend type checking (only if frontend was modified)
if [ "$FRONTEND_MODIFIED" = true ]; then
  echo "üîç Type checking frontend..."
  cd app/frontend && npx tsc --noEmit
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend type check failed!"
    exit 1
  fi
  cd ../..
else
  echo "‚è≠Ô∏è  Skipping frontend type check (no changes detected)"
fi

# Backend type checking (only if backend was modified)
if [ "$BACKEND_MODIFIED" = true ]; then
  echo "üîç Type checking backend..."
  cd app/backend && npx tsc --noEmit
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend type check failed!"
    exit 1
  fi
  cd ../..
else
  echo "‚è≠Ô∏è  Skipping backend type check (no changes detected)"
fi

# Lint-staged (Prettier on staged files only)
echo "üé® Formatting staged files..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "‚ùå Lint-staged failed!"
  exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
